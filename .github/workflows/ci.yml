name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          find . -name "*.json" -type f ! -path "./node_modules/*" ! -path "./.git/*" | while read file; do
            if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "Invalid JSON: $file"
              exit 1
            fi
          done
          echo "All JSON files are valid"

      - name: Check for large files
        run: |
          echo "Checking for files > 100MB not in LFS..."
          find . -type f -size +100M ! -path "./.git/*" | while read file; do
            if ! git lfs ls-files | grep -q "$file"; then
              echo "Large file not in LFS: $file"
              exit 1
            fi
          done
          echo "No large files outside LFS"

  notify:
    runs-on: ubuntu-latest
    needs: validate
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Validation: ${{ needs.validate.result }}" >> $GITHUB_STEP_SUMMARY
